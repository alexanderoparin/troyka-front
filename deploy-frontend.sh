#!/bin/bash

# ==================================================
# DEPLOY SCRIPT FOR NEXT.JS FRONTEND APPLICATION
# Author: Your Name
# Description: Auto-deploy script for troyka-front project
# ==================================================

# –¶–≤–µ—Ç–∞ –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
log() {
    echo -e "${BLUE}[$(date '+%Y-%m-%d %H:%M:%S')]${NC} $1"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
success() {
    echo -e "${GREEN}‚úì${NC} $1"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
warning() {
    echo -e "${YELLOW}‚ö†${NC} $1"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—à–∏–±–æ–∫
error() {
    echo -e "${RED}‚úó${NC} $1"
    exit 1
}

# ==================================================
# –ù–ê–°–¢–†–û–ô–ö–ò –°–ö–†–ò–ü–¢–ê
# ==================================================
PROJECT_DIR="/opt/troyka-front"
SERVICE_NAME="troyka-frontend"
BRANCH="main"
PORT="3000"
NGINX_SITE="troyka-front"

# ==================================================
# –û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê
# ==================================================

log "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –¥–µ–ø–ª–æ–π —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞..."
log "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –ø—Ä–æ–µ–∫—Ç–∞: $PROJECT_DIR"
log "–í–µ—Ç–∫–∞: $BRANCH"
log "–ü–æ—Ä—Ç: $PORT"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –ø—Ä–æ–µ–∫—Ç–∞
if [ ! -d "$PROJECT_DIR" ]; then
    error "Project directory $PROJECT_DIR does not exist!"
fi

cd "$PROJECT_DIR" || error "Cannot enter project directory!"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º git
if ! command -v git &> /dev/null; then
    error "Git is not installed!"
fi

# –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–∑ Git
log "–ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–∑ –≤–µ—Ç–∫–∏ $BRANCH..."
git fetch origin
git checkout $BRANCH
git pull origin $BRANCH

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ø–µ—à–Ω–æ—Å—Ç—å pull
if [ $? -ne 0 ]; then
    error "Git pull failed!"
fi

success "–ö–æ–¥ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º Node.js
if ! command -v node &> /dev/null; then
    error "Node.js is not installed!"
fi

if ! command -v npm &> /dev/null; then
    error "npm is not installed!"
fi

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
log "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
npm ci

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ø–µ—à–Ω–æ—Å—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫–∏
if [ $? -ne 0 ]; then
    error "npm install failed!"
fi

success "–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"

# –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç
log "–°–æ–±–∏—Ä–∞–µ–º Next.js –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ..."
npm run build

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ø–µ—à–Ω–æ—Å—Ç—å —Å–±–æ—Ä–∫–∏
if [ $? -ne 0 ]; then
    error "Build failed!"
fi

success "–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω–æ"

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º PM2 –ø—Ä–æ—Ü–µ—Å—Å
log "–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º PM2 –ø—Ä–æ—Ü–µ—Å—Å $SERVICE_NAME..."
pm2 stop $SERVICE_NAME 2>/dev/null || warning "Process $SERVICE_NAME was not running"

# –î–∞–µ–º –≤—Ä–µ–º—è –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
sleep 3

# –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ PM2
log "–ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ PM2..."
pm2 start ecosystem.config.js
pm2 save

# –î–∞–µ–º –≤—Ä–µ–º—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞
sleep 10

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å PM2 –ø—Ä–æ—Ü–µ—Å—Å–∞
log "–ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å PM2 –ø—Ä–æ—Ü–µ—Å—Å–∞..."
if pm2 list | grep -q "$SERVICE_NAME.*online"; then
    success "–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω–æ!"
else
    error "PM2 process failed to start!"
    echo "Showing PM2 logs:"
    pm2 logs $SERVICE_NAME --lines 20
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –ø–æ—Ä—Ç—É
log "–ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–∞ –ø–æ—Ä—Ç—É $PORT..."
if curl -s http://localhost:$PORT > /dev/null; then
    success "–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ localhost:$PORT"
else
    warning "–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ localhost:$PORT"
fi

# –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º Nginx
log "–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º Nginx..."
systemctl reload nginx

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å Nginx
if systemctl is-active --quiet nginx; then
    success "Nginx —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω"
else
    warning "Nginx –Ω–µ –∑–∞–ø—É—â–µ–Ω, –∑–∞–ø—É—Å–∫–∞–µ–º..."
    systemctl start nginx
fi

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å PM2
log "–°—Ç–∞—Ç—É—Å PM2 –ø—Ä–æ—Ü–µ—Å—Å–æ–≤:"
pm2 list

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏
log "–ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏..."
pm2 logs $SERVICE_NAME --lines 10

success "üéâ –î–µ–ø–ª–æ–π —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à—ë–Ω!"
log "Frontend is running on: http://213.171.4.47"
log "Backend API: http://213.171.4.47:8080"

# ==================================================
# –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
# ==================================================

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫–∞—Ç–∞ (–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∂–µ)
rollback() {
    log "Starting rollback..."
    # –õ–æ–≥–∏–∫–∞ –æ—Ç–∫–∞—Ç–∞
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –±—ç–∫–∞–ø–∞
backup() {
    log "Creating backup..."
    TIMESTAMP=$(date '+%Y%m%d_%H%M%S')
    BACKUP_DIR="/opt/backups/troyka-front_$TIMESTAMP"
    mkdir -p "$BACKUP_DIR"
    cp -r .next "$BACKUP_DIR/" 2>/dev/null || true
    cp package*.json "$BACKUP_DIR/" 2>/dev/null || true
    success "Backup created: $BACKUP_DIR"
}

# –í—ã–∑—ã–≤–∞–µ–º –±—ç–∫–∞–ø –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º (—Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
# backup
